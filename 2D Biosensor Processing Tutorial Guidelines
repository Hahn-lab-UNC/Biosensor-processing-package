Begin by opening MatLab r2015b.

Once opened, add the 2D Biosensor Processing Package to the file path by right clicking the folder of the package name in the MatLab workspace, hovering over 'Add to Path', and selecting 'Selected Folder and Subfolders'.

Add the folder where your data to process - shade images, raw images, and transformation matrix - is located to the file path by right clicking the respective folder(s) in the MatLab workspace, hovering over 'Add to Path', and selecting either 'Selected Folder Only' or 'Selected Folder and Subfolders'. If you select 'Selected Folder Only' it will NOT add to the path any of the folders that exist inside the selected folder or the files within those subfolders - it will only add to the path the files that exist in the folder. A folder is not a file. 

To begin processing, type 'masterScript' into the command line space in the Command Window of the MatLab environment. Press 'Enter' on the keyboard to run the script. 

The user will be prompted with an initial GUI for selecting various options. The options and their descriptions/functionalities are as follows:

	Single or Dual Chain?:
	- The user has the option to select Single Chain or Dual Chain biosensor 
	  processing. Single chain requires two channels to process, while dual 
	  chain requires a third channel.

	Split Composite Images?:
	- The user is able to select if their input images are individual channels 
	  or if their input images are composites of two channels. For example, their 
	  acquisition camera may collect the 256x256 images of both the FRET and donor 
	  channels and return to the user a composite image of size 512x256 where the 
	  left half of the image is the FRET channel, and the right half of the image 
	  is the donor channel. If the user selects 'Split' for this option, it is 
	  required that each processing image (ie. shade correction images, dark current
	  correction images, and the raw data) are in the composite format as this will 
	  assume that the images need to be split. If 'No Split' is selected, the software 
	  assumes that each channel is in an individual file (images already split) and 
	  will prompt the user for input for each channel

	Photobleach Correction?:
	- The user is able to select if photobleach correction will be applied to 
	  the data or not. A double exponential fit of the average intensity of each 
	  frame over time inside the thresholded region will be used for the fit.
	- It is required that input data have at least 4 time points in order to make 
	  a fit to apply photobleach correction. If the input has less than 4 time 
	  points, select 'No' to avoid errors in the processing.

	Ratio Image Filter Option:
	- The user can select whether or not to apply a hyper median filter (HMF)
	  to the final ratio image and save the filtered ratio image as a separate file. 
	  More filter options will be added in a later update.

	Dark Current Correction?:
	- The user has the option to select if dark current (or no light) correction will
	  be applied to the input images. If the option 'Yes' is selected, the user is 
	  expected to provide a dark current image in the format as the rest of the input 
	  images (composite images or pre-split images).

	Inverse Ratio?:
	- The user can select if they would like to calculate and save the inverse ratio 
	  image along with the standard ratio image. The standard ratio is FRET/donor
	  emission, the inverse ratio is donor/FRET emission. In a later update, 
	  FRET/acceptor emission will be added. 

	Align Cameras w/ Bead Images?:
	- The user can select whether or not to align images from two different acquisition 
	  cameras by using bead images supplied by the user. A transformation matrix is 
	  created by a GUI that the user is prompted with to perform the calculations. If
	  a transformation matrix is already in the file path of MatLab with the name 
	  'camera_transform.mat', instead of prompting the user to calculate a matrix with bead
	  images, it will use the transformation matrix already in the file path. If the
	  user is going to create a transformation matrix with the GUI and bead images, the
	  user should be sure to save the matrix with the name 'camera_transform.mat' within
	  the file path. 

	Registration?:
	- The user can choose whether or not to apply cross correlation registration 
	  (calculates x- and y- offset values to shift each frame of the donor image 
	  to match the FRET and acceptor images) before ratio images are calculated.

	Auto-Register w/ Masked Images?:
	- The user can select whether to have registration computed automatically using
	  masked images that are computed during the workflow (by selecting 'Yes'), or
	  to have a GUI appear in the workflow to manually perform registration.


Once the desired options have been selected, press 'Continue' in the lower right-hand corner of the Image Processing Options GUI. 

If the user selected 'Dual Chain' in the options menu, the user will be prompted in the command line to enter a value to be used as the bleedthrough coefficient for the donor channel (alpha value). Type the value in the command window and press enter to submit the alhpa value. The user will then be prompted in the command window to enter the bleedthrough coefficient for the acceptor channel (beta value). Again, type the value in the command window and press enter to submit (alpha and beta values of zero will suggest there is no bleedthrough from either the donor or acceptor channels, respectively). Bleedthrough coefficients can be calculated externally from this software package using specific input images collected and a different GUI. A future version of this package will incorporate an option to calculate the bleedthrough coefficients within the workflow of this software. Once the coefficients are submitted, processing will automatically continue to the next step. 

If the user selected 'Split' under the 'Split Composite Images?' option in the initial GUI, the user will be prompted with a second GUI to select the configuration of the composite images. There are two different options to choose from. The first option (default) is having the FRET/acceptor channel on the LEFT half of the composite image and the donor channel on the RIGHT half of the composite image. The second option is having the FRET/acceptor channel on the RIGHT half of the composite image and the donor channel on the LEFT half of the composite image. Once the appropriate option has been selected, press 'Continue' in the lower right-hand corner of the GUI.

The user will be prompted to select the working directory (or folder) where they would like to have all the data created and saved during the forthcoming processing steps. This working directory must exist inside of the file path or the processing will fail and throw an error.

If the user selected 'Yes' to 'Align Cameras w/ Bead Images?', then the user will be prompted with a GUI for computing a transformation matrix. If a transformation matrix of the name 'camera_transform.mat' is already located in the working directory, then the GUI will not open and this transformation matrix will be used for transforming the donor channel. Otherwise, the user must select the base and register bead images for the approrpiate channels in the GUI. The simplest method of calculating the transformation matrix is to select the bead image for the acceptor/fret channel as the base image and the bead image of the donor channel as the register image, keep the type of transformation on projective, keep the initial transformation as 'Generate initial transformation', change the initial transformation method to 'Spot Detection', set the approximate bead radius to '2', uncheck 'Refine transformatio', and click 'Calculate'. The GUI will display several figures showing the spot detection and alignment of the channels. These figures can be closed. Next, click 'Save' in the bottom right-hand corner of the GUI and save the transformation matrix as 'camera_transform.mat'. The GUI can then be closed. Click inside of the Command Window and press 'Enter' to continue with the processing workflow.

The user will then be prompted to select the necessary files in the following order:

	For composite images:
	- FRET/donor raw data file
	- FRET/donor shade file
	- acceptor/___ raw data file (if 'Dual Chain' was selected in options)
	- acceptor/___ shade file (if 'Dual Chain' was selected in options)
	- dark current (aka: no light) image (if 'Yes' was selected under 'Dark Current Correction?' 
	  option)
	- transformation matrix .mat file (if 'Yes' was selected under 'Align Cameras w/ Bead Images?' 
	  option)

	For already split images:
	- donor raw data file
	- FRET raw data file
	- donor shade file
	- FRET shade file
	- acceptor raw data file (if 'Dual Chain' was selected in options)
	- acceptor shade file (if 'Dual Chain' was selected in options)
	- dark current (aka: no light) in donor channel (if 'Yes' was selected under 'Dark Current 
	  Correction?' option)
	- dark current (aka: no light) in FRET channel (if 'Yes' was selected under 'Dark Current 
	  Correction?' option)
	- transformation matrix .mat file (if 'Yes' was selected under 'Align Cameras w/ Bead Images?' 
	  option)

Once all the necessary files have been selected, the initial processing will commence. Shade correction, dark current (no light) correction, splitting of images, and camera alignment will occur based on the options selected in the initial GUI. 

After this initial processing is completed, the user will be prompted with another GUI. This GUI will be used to define the region of interest, as well as calculate background correction. In the top left-hand corner of the GUI, click on 'File' and then click on 'Import'. This will open a window in the working directory designated earlier where several new files have been created and saved. Select either 'fret_sc' or 'donor_sc'. This will open the selected image in the GUI and default to a rainbow colormap. Next, in the top left-hand corner click on 'Tools' and then click on 'Zoom Box'. Then click anywhere on the image in the GUI. This will create a standard Zoom Box on the image. Click and hold in the middle of this zoom box to drag the box to a location on the image that only encompasses part of the background of the image. The zoom box can be resized for preference. There is a slider on the bottom of the GUI under the image to scroll through the various time points in the image stack. Ensure that the zoom box never incorporates any noticeable flouresnce across all time points. Once the zoom box is in the desired location, right click on the middle of the zoom box and select 'Copy Position'. In the command line in the MatLab environment, right click next to the prompt on the command line that states 'Enter Background Box:' and select 'Paste'. Press 'Enter' on the keyboard to submit this background box. The command line will then prompt the user with 'Enter Region Box:'. Return to the GUI window to drag and resize the box to a position that encompasses the entirety of the desired cell to analyze. Use the slider at the bottom of the GUI previously mentioned to ensure that the zoom box encompasses the desired cell across all time points. Once the zoom box is in the desired location, right click on the middle of the zoom box and select 'Copy Position'. Return to the command line in the MatLab environment to right click next to the prompt 'Enter Region Box:' and select 'Paste' to paste the region box. Press 'Enter' on the keyboard to submit this region box.

Once the background box and region box are submitted, background subtraction calculations will commence. Once this is completed, the user will be prompted with another GUI. This GUI will be used to calculate and refine the thresholding values for each frame in the image stack passed in. To begin, click on the 'File' tab in the upper left-hand corner of the GUI. Click on 'Import' to select the image you want to use. Preferably, select the image labeled 'donor_scbg_roi.tif', or select 'fret_scbg_roi.tif' (or 'acceptor_scbg_roi.tif' for dual chain processing) to calculate the threshold of the image in the specific channel. Once the image is imported, the GUI will automatically calculate threhold values for each frame. The progress of this calculation can be seen in the progress bar directly above the space to view the image on the left-hand side of the GUI. Once the calculation is completed, the image will appear with a yellow line around the thresholded region of the image. The threshold will always form a closed loop unless it reaches outside of the boundaries of the image. A scroll bar is located directly below the image that can be used to scan through the different frames in the image stack to view the threshold for each frame. On the right half of the GUI, a line graph will be displayed that represents the threshold values for each frame in the image stack. Directly to the right of the line graph will be a scroll bar with a value on either end. The top value represents the maximum threshold value that the line graph's y-axis shows. The bottom value represents the minimum threshold value that the line graph's y-axis shows. These parameters can be adjusted to display the line graph as desired. Below the line graph, there are several options for the graph. In the box labeled 'Curve Selection' there are three options to choose from. The first, called 'Suggested Curve', means you want to use the curve that the GUI automatically calculated for the threshold values. The second, called 'Smoothed Curve', fits a function curve to the current line graph being displayd to use as the threshold values. The third, called 'Custom Curve', allows the user to select their own threshold values for each of the frames in the image. To change the threshold value for a frame, use the scroll bar under the image on the left-hand side of the GUI to scroll to the desired frame. There should be a vertical red line in the line graph that will show where the frame you are viewing is located within that graph. Once 'Custom Curve' is selected, the scroll bar to the right of the line graph should become useable. The user can use this scroll bar to move the threshold value for that frame to the desired value. It is important to remember that the user is creating a new curve by selecting this option, so the previous values designated by the 'Suggested Curve' or 'Smoothed Curve' will NOT be used. The first and last frames are assigned a threshold value when 'Custom Curve' is selected and a new line graph will be made connecting all the points the user designates in the plot. A new point (or pivot) is created whenever the user moves to a frame and uses the scroll bar to adjust the threshold value. If this is done by mistake, the user can return to that frame and select the button 'Remove pivot' in the lower right-hand corner of the GUI. Once the 'Custom Curve' is satisfactory for the user (or whenever a new 'Curve Selection' option is selected and wanted to be used), the button 'Re-threshold' in the lower right-hand corner of the GUI can be clicked to apply the new threshold curve to the data in the image on the left-hand side. The GUI will begin to calculate and process these new values to place the yellow threshold lines onto the images. Once the threshold curve applied to the data is satisfactory for the user, the masks for the images can be saved. To save masks designated by the thresholding lines, click 'File' in the upper left-hand corner and then select 'Save as masks'. The user will be prompted with a save box to select the name of the save file and the location of the image. The name of the image will be preset to save as 'MaskedImages'. Depending on what images were used to calculate the threshold, the user must specify the filename as 'MaskedImages-fret' or 'MaskedImages-donor' (also 'MaskedImages-acceptor' if dual chain processing is occuring). Thresholding can be done individually for each channel, but oftentimes the mask is generated for only one channel, and the same mask is saved for each channel in the processing (ie. using the 'fret_scbg_roi.tif' images to save the mask as 'MaskedImages-fret', 'MaskedImages-donor', and 'MaskedImages-acceptor'). A mask must be created for each channel in the processing. If a mask is missing, the software will throw an error and cancel the processing. Once each mask is created, the user can close the GUI. On the command line window, there will be text that states 'Enter anything to continue'. The user can simply press any key to move on to the next step of the processing. 

The software will proceed to perform registration if calculating registration was selected. If the user selected 'Yes' for the option 'Auto-Register w/ Masked Images?', then the software will compute and save the registered donor image. If the user selected 'No' for the aforementioned option, then the user will be prompted with a GUI to perform manual registration (automatic registration is still computed and can be viewed and selected to use within the GUI). Once the GUI appears, in the top left-hand corner of the GUI, select 'File', and click on 'Import Images'. The user will be asked to first select the base image. This image acts as the basis for registering the other image to. For the FRET biosensor workflow, the FRET or acceptor channel will act as the basis image. The user will then be asked to select the register image. The register image acts as the image that will be registered, or the image which is shifted in the x- and y-axes to best align with the base image. Once the images have been selected, the automatic registration will be calculated and the two images, as well as an overlay of the two images, will be displayed in the GUI. This calculation may take a few minutes, but once the images appear in the GUI the calculation has completed. From here there is an option to select automatic or manual registration in the options panel in the bottom right-hand corner of the GUI. There are several other options the user can control as well. The offset values are displayed to the right of the options of automatic or manual registration. Once manual registration is selected, the two sliders next to the overlay image become usable. These can be used to set the offset for registration by whole pixel values with a constraint of -10 and 10 pixels in either the x or y direction. Once the offsets are determined suitable to the user, click on 'File' and 'Save Registered Image'. For the workflow of the package, save the registered donor image as 'donor_reg'. The file should automatically be saved in the '.tif' format. The registered image saved will be that of the register image shifted with the given offsets (if automatic registration is selected when saving, the automatically determined offsets will be used, otherwise, if the manual registration option is selected, the manually determined offsets will be used). Once the registered image is saved, go to the Command Window in the MatLab environment and press any key to continue the workflow.

The software will continue on to perform photobleach correction, rationg the images, and applying a filter to the ratio images as designated by the processing options in the beginning. Once this is all complete, several figures will appear showing various data produced by photobleaching. The command window will display the text 'Enter anything to close all windows and finish'. Once the user is finished looking at the prompted figures, any key can be pressed to finish processing, close all of the figures and GUIs remaining open, and clear the command window in the MatLab environment. The ratio image will be saved to a file called 'ratio_image.tif' in the working directory. All of the intermediate processing steps will have saved images that can be found in the working directory as well.

Once completed, any of the saved images can be viewed in any image viewer that can open '.tif' files.
